<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dawud Charity Hub - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .rotating {
            animation: rotate 1s linear infinite;
        }
        /* Toast notification */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Section -->
    <div id="login-section" class="min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-slate-100 to-slate-50">
        <div class="max-w-md w-full space-y-8 p-8 relative z-10">
            <!-- Logo and Header -->
            <div class="text-center">
                <div class="relative inline-block mb-6">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex items-center justify-center mx-auto shadow-lg">
                        <i class="fas fa-hand-holding-heart text-white text-2xl"></i>
                    </div>
                </div>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">
                    Admin Portal
                </h2>
                <p class="text-base text-gray-600">Dawud Charity Hub Management System</p>
            </div>

            <!-- Login Card -->
            <div class="relative">
                <div class="relative bg-white rounded-xl shadow-xl p-8 border border-gray-200 fade-in">
                    <form id="login-form" class="space-y-5">
                        <!-- Username Field -->
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
                                Username
                            </label>
                            <div class="relative">
                                <input type="text" id="username" name="username" required
                                       placeholder="Enter your username"
                                       class="block w-full px-4 py-3 pl-11 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                                <i class="fas fa-user absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>

                        <!-- Password Field -->
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                                Password
                            </label>
                            <div class="relative">
                                <input type="password" id="password" name="password" required
                                       placeholder="Enter your password"
                                       class="block w-full px-4 py-3 pl-11 pr-11 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                                <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <button type="button" id="toggle-password" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-600 transition-colors duration-200">
                                    <i class="fas fa-eye" id="password-eye"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Error Message -->
                        <div id="login-error" class="hidden p-4 bg-red-50 border border-red-300 text-red-700 rounded-lg text-sm animate-shake">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                <span id="error-message" class="font-medium"></span>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit"
                                class="w-full flex justify-center items-center py-3 px-4 border border-transparent text-sm font-semibold rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow transition-all duration-200">
                            <span id="login-text" class="flex items-center">
                                <i class="fas fa-sign-in-alt mr-2"></i>
                                Sign In
                            </span>
                            <div id="login-spinner" class="loading-spinner hidden"></div>
                        </button>
                    </form>

                    <!-- Footer Info -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="text-center">
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-shield-alt mr-1"></i>
                                Secure encrypted connection
                            </p>
                            <p class="mt-2 text-xs text-gray-400">
                                Contact your administrator for login credentials
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="hidden min-h-screen">
        <!-- Professional Modern Navigation -->
        <nav class="sticky top-0 z-50 bg-white border-b border-slate-200 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo and Brand Section -->
                    <div class="flex items-center space-x-4">
                        <div class="relative group">
                            <!-- Main logo container -->
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow duration-200">
                                <i class="fas fa-hand-holding-heart text-white text-lg"></i>
                            </div>
                            
                            <!-- Status indicator -->
                            <div class="absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-white"></div>
                        </div>
                        
                        <div class="hidden md:block border-l border-slate-200 pl-4">
                            <h1 class="text-xl font-bold text-slate-900 tracking-tight">
                                Dawud Charity Hub
                            </h1>
                            <p class="text-sm text-slate-500 font-medium">
                                Admin Dashboard
                            </p>
                        </div>
                    </div>

                    <!-- Right Section: Admin Info & Actions -->
                    <div class="flex items-center space-x-4">
                        <!-- Real-Time Connection Toggle -->
                        <div class="flex items-center space-x-2 px-3 py-2 bg-slate-50 rounded-lg border border-slate-200" title="Real-time updates via WebSocket">
                            <div class="relative">
                                <i id="refresh-icon" class="fas fa-wifi text-green-600 text-sm"></i>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="auto-refresh-toggle" class="sr-only peer" checked>
                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                            <span class="hidden md:inline text-xs font-medium text-slate-700" title="Live updates">Live</span>
                        </div>

                        <!-- Admin Welcome Card -->
                        <div class="hidden sm:flex items-center space-x-3 px-4 py-2 bg-slate-50 rounded-lg border border-slate-200 hover:border-slate-300 transition-colors duration-200">
                            <div class="relative">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user-shield text-blue-600 text-sm"></i>
                                </div>
                                <div class="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-white"></div>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-500 font-medium">Administrator</span>
                                <span id="admin-name" class="text-sm font-semibold text-slate-900">Admin</span>
                            </div>
                        </div>

                        <!-- Divider -->
                        <div class="hidden lg:block w-px h-8 bg-slate-200"></div>

                        <!-- Change Password Button -->
                        <button id="change-password-btn" class="group flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-sm hover:shadow transition-all duration-200">
                            <i class="fas fa-key text-sm group-hover:scale-110 transition-transform duration-200"></i>
                            <span class="hidden sm:inline">Change Password</span>
                        </button>

                        <!-- Logout Button -->
                        <button id="logout-btn" class="group flex items-center space-x-2 bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-sm hover:shadow transition-all duration-200">
                            <i class="fas fa-sign-out-alt text-sm group-hover:translate-x-0.5 transition-transform duration-200"></i>
                            <span class="hidden sm:inline">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto py-8 sm:px-6 lg:px-8">
            <!-- Modern Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <!-- Total Submissions Card -->
                <div class="group relative bg-gradient-to-br from-blue-50 via-white to-blue-50 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 border border-blue-100/50 overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                    <i class="fas fa-hand-holding-heart text-white text-lg"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Total Submissions</p>
                                    <p class="text-3xl font-bold text-gray-900" id="total-submissions">-</p>
                                </div>
                            </div>
                            <div class="opacity-20 group-hover:opacity-40 transition-opacity duration-300">
                                <i class="fas fa-chart-line text-4xl text-blue-400"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Verified Card -->
                <div class="group relative bg-gradient-to-br from-green-50 via-white to-green-50 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 border border-green-100/50 overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-green-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                    <i class="fas fa-check-circle text-white text-lg"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Verified</p>
                                    <p class="text-3xl font-bold text-gray-900" id="verified-count">-</p>
                                </div>
                            </div>
                            <div class="opacity-20 group-hover:opacity-40 transition-opacity duration-300">
                                <i class="fas fa-shield-alt text-4xl text-green-400"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pending Card -->
                <div class="group relative bg-gradient-to-br from-yellow-50 via-white to-yellow-50 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 border border-yellow-100/50 overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-yellow-500/5 to-orange-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                    <i class="fas fa-clock text-white text-lg"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Pending</p>
                                    <p class="text-3xl font-bold text-gray-900" id="pending-count">-</p>
                                </div>
                            </div>
                            <div class="opacity-20 group-hover:opacity-40 transition-opacity duration-300">
                                <i class="fas fa-hourglass-half text-4xl text-yellow-400"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Amount Card -->
                <div class="group relative bg-gradient-to-br from-purple-50 via-white to-purple-50 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 border border-purple-100/50 overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-purple-500/5 to-pink-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                    <i class="fas fa-coins text-white text-lg"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Total Verified Amount</p>
                                    <p class="text-3xl font-bold text-gray-900" id="total-amount">-</p>
                                </div>
                            </div>
                            <div class="opacity-20 group-hover:opacity-40 transition-opacity duration-300">
                                <i class="fas fa-money-bill-wave text-4xl text-purple-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Controls Section -->
            <div class="bg-gradient-to-br from-white via-slate-50 to-white rounded-2xl shadow-xl border border-slate-200/60 mb-8 p-6">
                <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center space-y-6 xl:space-y-0">

                    <!-- Search and Filter Section -->
                    <div class="flex flex-col lg:flex-row items-start lg:items-center space-y-4 lg:space-y-0 lg:space-x-6 w-full xl:w-auto">

                        <!-- Search Bar -->
                        <div class="relative flex-1 lg:flex-none lg:w-80">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="search-input" placeholder="Search by name, reference, or amount..."
                                       class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm">
                                <button id="clear-search" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors duration-300 hidden">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Filter Controls -->
                        <div class="flex flex-wrap items-center gap-4">
                            <!-- Status Filter -->
                            <div class="flex items-center space-x-3">
                                <label class="text-sm font-medium text-slate-700">Status:</label>
                                <select id="status-filter" class="px-3 py-2 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm">
                                    <option value="all">All Status</option>
                                    <option value="verified">Verified Only</option>
                                    <option value="pending">Pending Only</option>
                                </select>
                            </div>

                            <!-- Date Filter -->
                            <div class="flex items-center space-x-3">
                                <label class="text-sm font-medium text-slate-700">Period:</label>
                                <select id="date-filter" class="px-3 py-2 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="yesterday">Yesterday</option>
                                    <option value="this-week">This Week</option>
                                    <option value="last-week">Last Week</option>
                                    <option value="this-month">This Month</option>
                                    <option value="last-month">Last Month</option>
                                    <option value="last-7-days">Last 7 Days</option>
                                    <option value="last-30-days">Last 30 Days</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>

                            <!-- Bank Filter -->
                            <div class="flex items-center space-x-3">
                                <label class="text-sm font-medium text-slate-700">Bank:</label>
                                <select id="bank-filter" class="px-3 py-2 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm">
                                    <option value="all">All Banks</option>
                                </select>
                            </div>

                            <!-- Amount Range -->
                            <div class="flex items-center space-x-3">
                                <label class="text-sm font-medium text-slate-700">Min Amount:</label>
                                <input type="number" id="min-amount" placeholder="0" min="0"
                                       class="w-20 px-2 py-2 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm">
                            </div>
                        </div>

                        <!-- Custom Date Range (Hidden by default) -->
                        <div id="custom-date-range" class="hidden mt-4 flex flex-wrap items-center gap-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <label class="text-sm font-medium text-slate-700">
                                    <i class="fas fa-calendar-day mr-1 text-blue-600"></i>From:
                                </label>
                                <input type="date" id="date-from" class="px-3 py-2 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm">
                            </div>
                            <div class="flex items-center space-x-3">
                                <label class="text-sm font-medium text-slate-700">
                                    <i class="fas fa-calendar-day mr-1 text-blue-600"></i>To:
                                </label>
                                <input type="date" id="date-to" class="px-3 py-2 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm">
                            </div>
                            <button id="apply-custom-date" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold shadow-sm hover:shadow transition-all duration-200">
                                <i class="fas fa-check mr-1"></i>Apply
                            </button>
                        </div>
                    </div>

                    <!-- Action Controls -->
                    <div class="flex items-center space-x-4">
                        <!-- Refresh Button -->
                        <button id="refresh-btn" class="group relative bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-5 py-2.5 rounded-xl text-sm font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">
                            <i class="fas fa-sync-alt mr-2 group-hover:rotate-180 transition-transform duration-500"></i>Refresh
                            <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-blue-400 to-blue-500 opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                        </button>

                        <!-- Export Controls -->
                        <div class="flex items-center space-x-2">
                            <button id="export-csv-btn" class="group relative bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white px-4 py-2 rounded-xl text-sm font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">
                                <i class="fas fa-download mr-1 group-hover:scale-110 transition-transform duration-300"></i>CSV
                                <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-emerald-400 to-emerald-500 opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                            </button>
                            <button id="export-excel-btn" class="group relative bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-4 py-2 rounded-xl text-sm font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">
                                <i class="fas fa-file-excel mr-1 group-hover:scale-110 transition-transform duration-300"></i>Excel
                                <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-green-400 to-green-500 opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Active Filters Display -->
                <div id="active-filters" class="mt-4 flex flex-wrap items-center gap-2 hidden">
                    <span class="text-sm font-medium text-slate-600">Active filters:</span>
                </div>
            </div>

            <!-- Enhanced Submissions Table -->
            <div class="bg-gradient-to-br from-white via-slate-50 to-white rounded-2xl shadow-xl border border-slate-200/60 overflow-hidden">
                <!-- Table Header -->
                <div class="bg-gradient-to-r from-slate-50 via-slate-100 to-slate-50 border-b border-slate-200 px-6 py-6">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0">
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 via-purple-500 to-indigo-500 rounded-xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-list text-white text-lg"></i>
                                </div>
                                <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white animate-pulse"></div>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent">Donation Submissions</h3>
                                <p class="text-sm text-slate-600 font-medium">Manage and verify donation confirmations</p>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Table Content -->
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gradient-to-r from-slate-50 to-slate-100">
                            <tr class="border-b border-slate-200">
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-1">
                                        <i class="fas fa-receipt text-slate-400"></i>
                                        <span>Transaction Ref</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-1">
                                        <i class="fas fa-user text-slate-400"></i>
                                        <span>Donor</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-1">
                                        <i class="fas fa-envelope text-slate-400"></i>
                                        <span>Contact</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-1">
                                        <i class="fas fa-university text-slate-400"></i>
                                        <span>Bank</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-1">
                                        <i class="fas fa-coins text-slate-400"></i>
                                        <span>Amount</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-1">
                                        <i class="fas fa-check-circle text-slate-400"></i>
                                        <span>Status</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-1">
                                        <i class="fas fa-calendar text-slate-400"></i>
                                        <span>Date</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-1">
                                        <i class="fas fa-image text-slate-400"></i>
                                        <span>Screenshot</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    <div class="flex items-center justify-end space-x-1">
                                        <i class="fas fa-cogs text-slate-400"></i>
                                        <span>Actions</span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="submissions-body" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="9" class="px-6 py-12 text-center">
                                    <div class="flex flex-col items-center justify-center space-y-4">
                                        <div class="relative">
                                            <div class="loading-spinner w-8 h-8 mx-auto"></div>
                                            <div class="absolute inset-0 rounded-full bg-blue-100 animate-pulse"></div>
                                        </div>
                                        <p class="text-slate-600 font-medium">Loading submissions...</p>
                                        <p class="text-sm text-slate-500">Please wait while we fetch the latest data</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Modern Pagination -->
            <div id="pagination-section" class="mt-8 flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
                <div class="flex items-center space-x-2 text-sm text-slate-600">
                    <i class="fas fa-info-circle text-slate-400"></i>
                    <span>Showing <span id="start-record" class="font-semibold text-slate-900">0</span> to <span id="end-record" class="font-semibold text-slate-900">0</span> of <span id="total-records" class="font-semibold text-slate-900">0</span> results</span>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Rows per page selector -->
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-slate-700">Rows per page:</label>
                        <select id="rows-per-page" class="px-3 py-2 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <button id="prev-page" class="group relative bg-gradient-to-r from-slate-100 to-slate-200 hover:from-slate-200 hover:to-slate-300 disabled:from-gray-100 disabled:to-gray-100 text-slate-700 disabled:text-gray-400 px-4 py-2.5 rounded-xl text-sm font-medium shadow-sm hover:shadow-md disabled:shadow-sm disabled:cursor-not-allowed transition-all duration-300 disabled:opacity-50" disabled>
                        <i class="fas fa-chevron-left mr-2 group-hover:-translate-x-0.5 transition-transform duration-300"></i>Previous
                        <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-slate-50 to-slate-100 opacity-0 group-hover:opacity-50 transition-opacity duration-300"></div>
                    </button>
                    <button id="next-page" class="group relative bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-4 py-2.5 rounded-xl text-sm font-medium shadow-lg hover:shadow-xl disabled:shadow-lg disabled:cursor-not-allowed transition-all duration-300 disabled:opacity-50" disabled>
                        Next<i class="fas fa-chevron-right ml-2 group-hover:translate-x-0.5 transition-transform duration-300"></i>
                        <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-blue-400 to-blue-500 opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="image-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden fade-in">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-image text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900">Donation Proof</h3>
                </div>
                <button id="close-image-modal" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-auto max-h-[calc(90vh-120px)]">
                <div id="image-loading" class="flex flex-col items-center justify-center py-12">
                    <div class="loading-spinner w-12 h-12 mb-4"></div>
                    <p class="text-gray-600">Loading image...</p>
                </div>
                <div id="image-content" class="hidden">
                    <img id="preview-image" src="" alt="Donation Proof" class="w-full h-auto rounded-lg shadow-lg">
                </div>
                <div id="image-error" class="hidden text-center py-12">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <p class="text-red-600 font-medium">Failed to load image</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 fade-in">
            <div class="flex items-start space-x-4">
                <div id="confirmation-icon" class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center">
                    <!-- Icon will be set dynamically -->
                </div>
                <div class="flex-1">
                    <h3 id="confirmation-title" class="text-lg font-bold text-gray-900 mb-2">
                        <!-- Title will be set dynamically -->
                    </h3>
                    <p id="confirmation-message" class="text-sm text-gray-600 mb-4">
                        <!-- Message will be set dynamically -->
                    </p>
                    <div class="flex items-center space-x-3">
                        <button id="confirmation-confirm" class="flex-1 px-4 py-2 rounded-lg text-sm font-semibold text-white shadow-sm hover:shadow transition-all duration-200">
                            Confirm
                        </button>
                        <button id="confirmation-cancel" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-semibold text-gray-700 transition-all duration-200">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="password-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 fade-in">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-key text-white text-lg"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900">Change Password</h3>
                </div>
                <button id="close-password-modal" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="change-password-form" class="space-y-5">
                <div>
                    <label for="current-password" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-lock mr-1 text-gray-400"></i>Current Password
                    </label>
                    <input type="password" id="current-password" name="current-password" required
                           class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                </div>

                <div>
                    <label for="new-password" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-key mr-1 text-gray-400"></i>New Password
                    </label>
                    <input type="password" id="new-password" name="new-password" required minlength="8"
                           class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                    <p class="mt-1 text-xs text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>Minimum 8 characters required
                    </p>
                </div>

                <div>
                    <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-check-circle mr-1 text-gray-400"></i>Confirm New Password
                    </label>
                    <input type="password" id="confirm-password" name="confirm-password" required minlength="8"
                           class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                </div>

                <div id="password-error" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="password-error-message"></span>
                </div>

                <div id="password-success" class="hidden p-3 bg-green-100 border border-green-400 text-green-700 rounded-lg text-sm">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span id="password-success-message"></span>
                </div>

                <div class="flex items-center space-x-3 pt-4">
                    <button type="submit"
                            class="flex-1 group relative bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-lg text-sm font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="password-submit-text">
                            <i class="fas fa-check mr-2"></i>Update Password
                        </span>
                        <div id="password-submit-spinner" class="loading-spinner hidden"></div>
                    </button>
                    <button type="button" id="cancel-password-change"
                            class="px-6 py-3 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-50 transition-all duration-200">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        let currentToken = null;
        let currentPage = 0;
        let itemsPerPage = 20;
        let totalSubmissions = 0;
        let allSubmissions = [];
        let filteredSubmissions = [];
        let currentSort = { field: 'submitted_at', direction: 'desc' };
        let searchTerm = '';
        let statusFilter = 'all';
        let bankFilter = 'all';
        let minAmount = 0;
        let dateFilter = 'all';
        let customDateFrom = null;
        let customDateTo = null;
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;
        let lastSubmissionCount = 0;
        
        // WebSocket variables
        let ws = null;
        let wsReconnectAttempts = 0;
        let wsMaxReconnectAttempts = 5;
        let wsReconnectDelay = 3000; // Start with 3 seconds
        let wsConnected = false;

        // Get stored token
        function getStoredToken() {
            const token = localStorage.getItem('admin_token');
            console.log('Retrieved token from storage:', token ? token.substring(0, 20) + '...' : 'None');
            return token;
        }

        // Date Range Helper Functions
        function getDateRange(filterType) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let startDate, endDate;

            switch(filterType) {
                case 'today':
                    startDate = today;
                    endDate = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    break;
                
                case 'yesterday':
                    startDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    endDate = today;
                    break;
                
                case 'this-week':
                    const dayOfWeek = today.getDay();
                    const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Start from Monday
                    startDate = new Date(today.setDate(diff));
                    endDate = new Date(startDate.getTime() + 7 * 24 * 60 * 60 * 1000);
                    break;
                
                case 'last-week':
                    const lastWeekStart = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    const lastWeekDay = lastWeekStart.getDay();
                    const lastWeekDiff = lastWeekStart.getDate() - lastWeekDay + (lastWeekDay === 0 ? -6 : 1);
                    startDate = new Date(lastWeekStart.setDate(lastWeekDiff));
                    endDate = new Date(startDate.getTime() + 7 * 24 * 60 * 60 * 1000);
                    break;
                
                case 'this-month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                    break;
                
                case 'last-month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                    break;
                
                case 'last-7-days':
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    endDate = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    break;
                
                case 'last-30-days':
                    startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    endDate = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    break;
                
                case 'custom':
                    if (customDateFrom && customDateTo) {
                        startDate = new Date(customDateFrom);
                        endDate = new Date(customDateTo);
                        endDate.setHours(23, 59, 59, 999);
                    }
                    break;
                
                default:
                    return null;
            }

            return { startDate, endDate };
        }

        function isDateInRange(dateStr, range) {
            if (!range) return true;
            const date = new Date(dateStr);
            return date >= range.startDate && date <= range.endDate;
        }

        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const errorMessage = document.getElementById('error-message');
        const loginText = document.getElementById('login-text');
        const loginSpinner = document.getElementById('login-spinner');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded, initializing...');

            // Initialize password toggle
            initPasswordToggle();

            // Wait a bit to ensure all elements are rendered
            setTimeout(() => {
                console.log('Page loaded, checking token...');
                currentToken = getStoredToken();
                console.log('Current token after retrieval:', currentToken ? 'Present (length: ' + currentToken.length + ')' : 'Missing');
                if (currentToken) {
                    console.log('Token exists, showing dashboard');
                    showDashboard();
                } else {
                    console.log('No token, showing login');
                    showLogin();
                }
            }, 100);
        });

        // Password Toggle Functionality
        function initPasswordToggle() {
            const togglePasswordBtn = document.getElementById('toggle-password');
            const passwordInput = document.getElementById('password');
            const passwordEye = document.getElementById('password-eye');

            if (togglePasswordBtn && passwordInput && passwordEye) {
                togglePasswordBtn.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    
                    // Toggle eye icon
                    if (type === 'text') {
                        passwordEye.classList.remove('fa-eye');
                        passwordEye.classList.add('fa-eye-slash');
                        togglePasswordBtn.classList.add('text-blue-600');
                    } else {
                        passwordEye.classList.remove('fa-eye-slash');
                        passwordEye.classList.add('fa-eye');
                        togglePasswordBtn.classList.remove('text-blue-600');
                    }
                });
            }
        }


        // Login Form Handler
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            showLoginLoading(true);

            try {
                console.log('Attempting login for user:', username);
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                console.log('Login response status:', response.status);
                const data = await response.json();
                console.log('Login response data:', data);

                if (response.ok) {
                    currentToken = data.access_token;
                    localStorage.setItem('admin_token', currentToken);
                    console.log('Token stored successfully:', currentToken.substring(0, 20) + '...');
                    console.log('Token stored, showing dashboard');
                    showDashboard();
                } else {
                    console.error('Login failed:', response.status, data);
                    showLoginError(data.detail || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Network error. Please try again.');
            } finally {
                showLoginLoading(false);
            }
        });

        // Logout Handler
        document.getElementById('logout-btn').addEventListener('click', function() {
            // Stop auto-refresh
            stopAutoRefresh();
            localStorage.removeItem('admin_token');
            currentToken = null;
            showLogin();
        });

        // Change Password Modal Handlers
        const passwordModal = document.getElementById('password-modal');
        const changePasswordBtn = document.getElementById('change-password-btn');
        const closePasswordModal = document.getElementById('close-password-modal');
        const cancelPasswordChange = document.getElementById('cancel-password-change');
        const changePasswordForm = document.getElementById('change-password-form');

        // Open password modal
        changePasswordBtn.addEventListener('click', function() {
            passwordModal.classList.remove('hidden');
            document.getElementById('current-password').focus();
            // Clear form and messages
            changePasswordForm.reset();
            document.getElementById('password-error').classList.add('hidden');
            document.getElementById('password-success').classList.add('hidden');
        });

        // Close password modal
        function closePasswordModalFunc() {
            passwordModal.classList.add('hidden');
            changePasswordForm.reset();
            document.getElementById('password-error').classList.add('hidden');
            document.getElementById('password-success').classList.add('hidden');
        }

        closePasswordModal.addEventListener('click', closePasswordModalFunc);
        cancelPasswordChange.addEventListener('click', closePasswordModalFunc);

        // Close modal when clicking outside
        passwordModal.addEventListener('click', function(e) {
            if (e.target === passwordModal) {
                closePasswordModalFunc();
            }
        });

        // Handle password change form submission
        changePasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            // Hide previous messages
            document.getElementById('password-error').classList.add('hidden');
            document.getElementById('password-success').classList.add('hidden');

            // Validate new password matches confirm password
            if (newPassword !== confirmPassword) {
                showPasswordError('New password and confirm password do not match');
                return;
            }

            // Validate new password length
            if (newPassword.length < 8) {
                showPasswordError('New password must be at least 8 characters long');
                return;
            }

            // Validate new password is different from current
            if (currentPassword === newPassword) {
                showPasswordError('New password must be different from current password');
                return;
            }

            showPasswordLoading(true);

            try {
                const token = getStoredToken();
                if (!token) {
                    showPasswordError('Authentication required. Please log in again.');
                    return;
                }

                const response = await fetch(`${API_BASE}/api/admin/change-password`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showPasswordSuccess('Password changed successfully! Logging you out...');
                    // Clear form
                    changePasswordForm.reset();
                    // Log out and redirect to login after 2 seconds
                    setTimeout(() => {
                        closePasswordModalFunc();
                        // Clear token and redirect to login
                        localStorage.removeItem('admin_token');
                        currentToken = null;
                        showLogin();
                    }, 2000);
                } else {
                    showPasswordError(data.detail || 'Failed to change password');
                }
            } catch (error) {
                console.error('Password change error:', error);
                showPasswordError('Network error. Please try again.');
            } finally {
                showPasswordLoading(false);
            }
        });

        function showPasswordLoading(loading) {
            const submitText = document.getElementById('password-submit-text');
            const submitSpinner = document.getElementById('password-submit-spinner');
            const submitBtn = changePasswordForm.querySelector('button[type="submit"]');

            if (loading) {
                submitText.classList.add('hidden');
                submitSpinner.classList.remove('hidden');
                submitBtn.disabled = true;
            } else {
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
                submitBtn.disabled = false;
            }
        }

        function showPasswordError(message) {
            const errorDiv = document.getElementById('password-error');
            const errorMessage = document.getElementById('password-error-message');
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('password-success').classList.add('hidden');
        }

        function showPasswordSuccess(message) {
            const successDiv = document.getElementById('password-success');
            const successMessage = document.getElementById('password-success-message');
            successMessage.textContent = message;
            successDiv.classList.remove('hidden');
            document.getElementById('password-error').classList.add('hidden');
        }

        // Show Login Functions
        function showLogin() {
            console.log('Showing login section...');
            loginSection.classList.remove('hidden');
            dashboardSection.classList.add('hidden');
            const usernameInput = document.getElementById('username');
            if (usernameInput) {
                usernameInput.focus();
                console.log('Username input focused');
            } else {
                console.error('Username input not found');
            }
        }

        function showLoginLoading(loading) {
            if (loading) {
                loginText.classList.add('hidden');
                loginSpinner.classList.remove('hidden');
                loginForm.querySelector('button[type="submit"]').disabled = true;
            } else {
                loginText.classList.remove('hidden');
                loginSpinner.classList.add('hidden');
                loginForm.querySelector('button[type="submit"]').disabled = false;
            }
        }

        function showLoginError(message) {
            errorMessage.textContent = message;
            loginError.classList.remove('hidden');
            // Trigger shake animation
            loginError.classList.remove('animate-shake');
            void loginError.offsetWidth; // Trigger reflow to restart animation
            loginError.classList.add('animate-shake');
        }

        // Show Dashboard Functions
        async function showDashboard() {
            console.log('Showing dashboard...');
            currentToken = getStoredToken();
            console.log('Current token before dashboard load:', currentToken ? currentToken.substring(0, 20) + '...' : 'None');

            loginSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            document.getElementById('admin-name').textContent = 'Admin';

            console.log('Loading dashboard data...');
            await loadDashboardStats();
            await loadSubmissions();

            // Initialize filter functionality
            initFilterListeners();
            initPaginationHandlers();
            initRefreshHandler();
            initAutoRefresh();
            initExportHandlers();
            await populateBankFilter();

            // Start auto-refresh if enabled
            if (autoRefreshEnabled) {
                startAutoRefresh();
            }
        }

        // Toast Notification System
        function showToast(message, type = 'info', duration = 4000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const icons = {
                success: 'fa-check-circle text-green-500',
                info: 'fa-info-circle text-blue-500',
                warning: 'fa-exclamation-triangle text-yellow-500',
                error: 'fa-times-circle text-red-500'
            };

            const colors = {
                success: 'bg-green-50 border-green-200',
                info: 'bg-blue-50 border-blue-200',
                warning: 'bg-yellow-50 border-yellow-200',
                error: 'bg-red-50 border-red-200'
            };

            toast.className = `toast ${colors[type]} border rounded-lg shadow-lg p-4 mb-4`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${icons[type]} text-xl mr-3"></i>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            toastContainer.appendChild(toast);

            // Auto remove after duration
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // WebSocket Functions for Real-Time Updates
        function connectWebSocket() {
            const token = getStoredToken();
            if (!token) {
                console.log('No token available for WebSocket connection');
                return;
            }

            // Close existing connection if any
            if (ws) {
                ws.close();
            }

            // Determine WebSocket URL (ws:// or wss://)
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.hostname}:8000/ws/admin?token=${encodeURIComponent(token)}`;
            
            console.log('Connecting to WebSocket...');
            
            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function() {
                    console.log(' WebSocket connected!');
                    wsConnected = true;
                    wsReconnectAttempts = 0;
                    wsReconnectDelay = 3000;
                    updateConnectionStatus(true);
                    showToast('Real-time connection established', 'success', 2000);
                    
                    // Send ping every 30 seconds to keep connection alive
                    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
                    autoRefreshInterval = setInterval(() => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({ type: 'ping' }));
                        }
                    }, 30000);
                };

                ws.onmessage = async function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        console.log(' WebSocket message received:', message);
                        
                        // Handle different message types
                        switch(message.type) {
                            case 'connection_established':
                                console.log('Connection established:', message.message);
                                break;
                                
                            case 'pong':
                                console.log('Pong received');
                                break;
                                
                            case 'new_donation':
                                handleNewDonation(message.data);
                                break;
                                
                            case 'donation_verified':
                            case 'donation_unverified':
                                handleVerificationUpdate(message.data);
                                break;
                                
                            case 'stats_update':
                                handleStatsUpdate(message.data);
                                break;
                                
                            default:
                                console.log('Unknown message type:', message.type);
                        }
                    } catch (error) {
                        console.error('Error processing WebSocket message:', error);
                    }
                };

                ws.onerror = function(error) {
                    console.error(' WebSocket error:', error);
                    wsConnected = false;
                    updateConnectionStatus(false);
                };

                ws.onclose = function(event) {
                    console.log('WebSocket closed:', event.code, event.reason);
                    wsConnected = false;
                    updateConnectionStatus(false);
                    
                    // Clear ping interval
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                        autoRefreshInterval = null;
                    }
                    
                    // Attempt to reconnect if enabled
                    if (autoRefreshEnabled && wsReconnectAttempts < wsMaxReconnectAttempts) {
                        wsReconnectAttempts++;
                        console.log(`Reconnecting in ${wsReconnectDelay}ms (attempt ${wsReconnectAttempts}/${wsMaxReconnectAttempts})...`);
                        setTimeout(() => {
                            connectWebSocket();
                        }, wsReconnectDelay);
                        // Exponential backoff
                        wsReconnectDelay = Math.min(wsReconnectDelay * 1.5, 30000);
                    } else if (wsReconnectAttempts >= wsMaxReconnectAttempts) {
                        showToast('Connection lost. Please refresh the page.', 'error', 5000);
                    }
                };
            } catch (error) {
                console.error('Error creating WebSocket:', error);
                updateConnectionStatus(false);
            }
        }

        function disconnectWebSocket() {
            if (ws) {
                console.log('Disconnecting WebSocket...');
                ws.close();
                ws = null;
            }
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function updateConnectionStatus(connected) {
            const refreshIcon = document.getElementById('refresh-icon');
            if (refreshIcon) {
                if (connected) {
                    refreshIcon.classList.add('rotating');
                    refreshIcon.style.color = '#10b981'; // Green
                } else {
                    refreshIcon.classList.remove('rotating');
                    refreshIcon.style.color = '#ef4444'; // Red
                }
            }
        }

        // Handle real-time events
        async function handleNewDonation(donationData) {
            console.log(' New donation received:', donationData);
            
            // Add to allSubmissions
            allSubmissions.unshift(donationData);
            lastSubmissionCount = allSubmissions.length;
            
            // Refresh stats and table
            await loadDashboardStats();
            applyFiltersAndSort();
            
            // Show notification
            showToast(
                `New donation from ${donationData.donor_name} (${donationData.amount_donated} ETB)`,
                'success',
                5000
            );
        }

        async function handleVerificationUpdate(updateData) {
            console.log(' Verification update:', updateData);
            
            // Find and update the submission
            const submission = allSubmissions.find(s => s.id === updateData.id);
            if (submission) {
                submission.is_verified = updateData.is_verified;
                submission.verified_by = updateData.verified_by;
                submission.verified_at = updateData.verified_at;
            }
            
            // Refresh stats and table
            await loadDashboardStats();
            applyFiltersAndSort();
            
            // Show notification
            const action = updateData.is_verified ? 'verified' : 'unverified';
            showToast(
                `Donation ${action} by ${updateData.verified_by}`,
                'info',
                3000
            );
        }

        async function handleStatsUpdate(statsData) {
            console.log(' Stats update:', statsData);
            // Update stats display
            updateStatsDisplay(statsData);
        }

        function updateStatsDisplay(stats) {
            const totalEl = document.getElementById('total-submissions');
            const verifiedEl = document.getElementById('verified-count-display');
            const pendingEl = document.getElementById('pending-count-display');
            const amountEl = document.getElementById('total-amount');

            if (totalEl) totalEl.textContent = stats.total_submissions;
            if (verifiedEl) verifiedEl.textContent = stats.verified_count;
            if (pendingEl) pendingEl.textContent = stats.pending_count;
            if (amountEl) amountEl.textContent = stats.total_amount.toLocaleString('en-US', { minimumFractionDigits: 2 });
        }

        // Initialize Auto-Refresh Toggle (Now controls WebSocket)
        function initAutoRefresh() {
            const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
            
            if (autoRefreshToggle) {
                autoRefreshToggle.addEventListener('change', function() {
                    autoRefreshEnabled = this.checked;
                    
                    if (autoRefreshEnabled) {
                        connectWebSocket();
                        showToast('Real-time updates enabled', 'success', 2000);
                    } else {
                        disconnectWebSocket();
                        updateConnectionStatus(false);
                        showToast('Real-time updates disabled', 'info', 2000);
                    }
                });
            }
        }

        // Legacy functions for compatibility
        function startAutoRefresh() {
            connectWebSocket();
        }

        function stopAutoRefresh() {
            disconnectWebSocket();
        }


        // Load Dashboard Statistics
        async function loadDashboardStats() {
            try {
                console.log('Loading dashboard stats...');
                console.log('API_BASE:', API_BASE);
                const token = getStoredToken();
                if (!token) {
                    console.log('No token available, cannot load stats');
                    return;
                }

                const response = await fetch(`${API_BASE}/api/admin/dashboard-stats`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Dashboard stats response status:', response.status);

                if (response.status === 401) {
                    console.log('401 Unauthorized - token expired or invalid');
                    // Token expired or invalid
                    localStorage.removeItem('admin_token');
                    currentToken = null;
                    showLogin();
                    return;
                }

                if (!response.ok) {
                    console.error('Dashboard stats API error:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const stats = await response.json();
                console.log('Received stats:', stats);

                // Update dashboard cards
                document.getElementById('total-submissions').textContent = stats.total_submissions || '0';
                document.getElementById('verified-count').textContent = stats.verified_count || '0';
                document.getElementById('pending-count').textContent = stats.pending_count || '0';
                document.getElementById('total-amount').textContent = `${(stats.total_amount || 0).toLocaleString()} ETB`;

                // Update total submissions count for pagination
                totalSubmissions = stats.total_submissions || 0;

                console.log('Dashboard stats updated successfully');

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                // Set default values on error
                document.getElementById('total-submissions').textContent = '0';
                document.getElementById('verified-count').textContent = '0';
                document.getElementById('pending-count').textContent = '0';
                document.getElementById('total-amount').textContent = '0 ETB';
            }
        }

        // Load Submissions
        async function loadSubmissions() {
            try {
                const params = new URLSearchParams({
                    skip: currentPage * itemsPerPage,
                    limit: itemsPerPage,
                    verified_only: false  // Always load all submissions - filtering is handled client-side
                });

                console.log('Loading submissions with params:', params.toString());

                const token = getStoredToken();
                if (!token) {
                    console.log('No token available for submissions');
                    showTableError('Authentication required. Please log in again.');
                    return;
                }

                const response = await fetch(`${API_BASE}/api/admin/submissions?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Submissions response status:', response.status);

                if (response.status === 401) {
                    // Token expired or invalid
                    console.log('Token expired, redirecting to login');
                    localStorage.removeItem('admin_token');
                    showLogin();
                    return;
                }

                if (!response.ok) {
                    console.error('Submissions API error:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error response body:', errorText);
                    showTableError(`Error loading submissions: ${response.status} ${response.statusText}`);
                    return;
                }

                let submissions;
                try {
                    const responseText = await response.text();
                    console.log('Raw response length:', responseText.length);
                    console.log('Raw response:', responseText.substring(0, 300) + '...');

                    if (!responseText.trim()) {
                        console.error('Empty response body');
                        showTableError('Empty response from server');
                        return;
                    }

                    submissions = JSON.parse(responseText);
                    console.log('Parsed submissions type:', typeof submissions);
                    console.log('Parsed submissions length:', submissions?.length);
                    console.log('Parsed submissions isArray:', Array.isArray(submissions));

                    if (submissions === null || submissions === undefined) {
                        console.error('Response is null/undefined');
                        showTableError('Invalid response from server');
                        return;
                    }

                    if (!Array.isArray(submissions)) {
                        console.error('Response is not an array:', typeof submissions, submissions);
                        showTableError('Invalid response format from server - expected array');
                        return;
                    }

                    if (submissions.length > 0) {
                        console.log('First submission structure:', submissions[0]);
                        console.log('First submission keys:', Object.keys(submissions[0]));
                    }

                } catch (parseError) {
                    console.error('JSON parsing error:', parseError);
                    console.error('Response status:', response.status);
                    console.error('Response headers:', Object.fromEntries(response.headers.entries()));
                    showTableError('Failed to parse server response: ' + parseError.message);
                    return;
                }

                allSubmissions = submissions || [];
                // Update total submissions count with actual loaded data
                totalSubmissions = allSubmissions.length;

                console.log('About to apply filters and sort...');
                console.log('allSubmissions length:', allSubmissions.length);
                console.log('Sample submission:', allSubmissions[0]);

                try {
                    applyFiltersAndSort();

                    try {
                        updatePagination();
                    } catch (paginationError) {
                        console.error('Error updating pagination:', paginationError);
                    }

                    try {
                        updateTableStats();
                    } catch (statsError) {
                        console.error('Error updating table stats:', statsError);
                    }

                    console.log('Successfully processed submissions');
                } catch (processError) {
                    console.error('Error processing submissions:', processError);
                    showTableError('Error processing submission data: ' + processError.message);
                }

            } catch (error) {
                console.error('Error loading submissions:', error);
                showTableError('Error loading submissions. Please check your connection and try again.');
            }
        }

        // Apply Search, Filters, and Sorting
        function applyFiltersAndSort() {
            console.log('applyFiltersAndSort called');
            console.log('allSubmissions type:', typeof allSubmissions);
            console.log('allSubmissions is array:', Array.isArray(allSubmissions));

            if (!Array.isArray(allSubmissions)) {
                console.error('allSubmissions is not an array:', allSubmissions);
                showTableError('Invalid submissions data format');
                return;
            }

            let filtered = [...allSubmissions];
            console.log('Initial filtered length:', filtered.length);

            // Apply search filter
            if (searchTerm) {
                console.log('Applying search filter for:', searchTerm);
                filtered = filtered.filter(submission => {
                    try {
                        const searchLower = searchTerm.toLowerCase();
                        return (
                            (submission.transaction_reference || '').toLowerCase().includes(searchLower) ||
                            submission.donor_name.toLowerCase().includes(searchLower) ||
                            submission.donor_contact.toLowerCase().includes(searchLower) ||
                            submission.bank_used.toLowerCase().includes(searchLower) ||
                            submission.amount_donated.toLowerCase().includes(searchLower)
                        );
                    } catch (filterError) {
                        console.error('Error in search filter:', filterError, 'for submission:', submission);
                        return false;
                    }
                });
                console.log('After search filter:', filtered.length);
            }

            // Apply status filter
            if (statusFilter !== 'all') {
                console.log('Applying status filter:', statusFilter);
                try {
                    if (statusFilter === 'verified') {
                        filtered = filtered.filter(s => s.is_verified);
                    } else if (statusFilter === 'pending') {
                        filtered = filtered.filter(s => !s.is_verified);
                    }
                    console.log('After status filter:', filtered.length);
                } catch (statusError) {
                    console.error('Error in status filter:', statusError);
                }
            }

            // Apply bank filter
            if (bankFilter !== 'all') {
                console.log('Applying bank filter:', bankFilter);
                try {
                    filtered = filtered.filter(s => s.bank_used && s.bank_used.toLowerCase() === bankFilter.toLowerCase());
                    console.log('After bank filter:', filtered.length);
                } catch (bankError) {
                    console.error('Error in bank filter:', bankError);
                }
            }

            // Apply amount filter
            if (minAmount > 0) {
                console.log('Applying amount filter:', minAmount);
                try {
                    filtered = filtered.filter(s => {
                        try {
                            const amount = parseFloat(s.amount_donated.replace(/[^\d.]/g, '')) || 0;
                            return amount >= minAmount;
                        } catch (amountError) {
                            console.error('Error parsing amount for submission:', s, amountError);
                            return false;
                        }
                    });
                    console.log('After amount filter:', filtered.length);
                } catch (amountFilterError) {
                    console.error('Error in amount filter:', amountFilterError);
                }
            }

            // Apply date filter
            if (dateFilter !== 'all') {
                console.log('Applying date filter:', dateFilter);
                try {
                    const dateRange = getDateRange(dateFilter);
                    if (dateRange) {
                        filtered = filtered.filter(s => {
                            try {
                                return isDateInRange(s.submitted_at, dateRange);
                            } catch (dateError) {
                                console.error('Error checking date for submission:', s, dateError);
                                return false;
                            }
                        });
                        console.log('After date filter:', filtered.length);
                    }
                } catch (dateFilterError) {
                    console.error('Error in date filter:', dateFilterError);
                }
            }

            // Apply sorting
            try {
                console.log('Applying sort by:', currentSort.field, currentSort.direction);
                filtered.sort((a, b) => {
                    try {
                        let aVal = a[currentSort.field];
                        let bVal = b[currentSort.field];

                        // Handle different field types
                        if (currentSort.field === 'submitted_at') {
                            aVal = new Date(aVal);
                            bVal = new Date(bVal);
                        } else if (currentSort.field === 'amount_donated') {
                            aVal = parseFloat(aVal.replace(/[^\d.]/g, '')) || 0;
                            bVal = parseFloat(bVal.replace(/[^\d.]/g, '')) || 0;
                        } else if (typeof aVal === 'string') {
                            aVal = aVal.toLowerCase();
                            bVal = bVal.toLowerCase();
                        }

                        if (currentSort.direction === 'asc') {
                            return aVal > bVal ? 1 : -1;
                        } else {
                            return aVal < bVal ? 1 : -1;
                        }
                    } catch (sortError) {
                        console.error('Error sorting submissions:', sortError, 'for values:', a[currentSort.field], b[currentSort.field]);
                        return 0;
                    }
                });
                console.log('After sorting:', filtered.length);
            } catch (sortError) {
                console.error('Error in sorting:', sortError);
            }

            filteredSubmissions = Array.isArray(filtered) ? filtered : [];

            try {
                if (filteredSubmissions.length === 0) {
                    console.log('No submissions to display');
                    displaySubmissions([]);
                    return;
                }

                const startIndex = currentPage * itemsPerPage;
                const endIndex = Math.min((currentPage + 1) * itemsPerPage, filteredSubmissions.length);
                const pageData = filteredSubmissions.slice(startIndex, endIndex);

                console.log('Displaying page data:', {
                    currentPage,
                    itemsPerPage,
                    startIndex,
                    endIndex,
                    pageDataLength: pageData.length,
                    totalFiltered: filteredSubmissions.length
                });

                displaySubmissions(pageData);
            } catch (displayError) {
                console.error('Error preparing page data:', displayError);
                console.error('filteredSubmissions type:', typeof filteredSubmissions);
                console.error('filteredSubmissions is array:', Array.isArray(filteredSubmissions));
                console.error('filteredSubmissions length:', filteredSubmissions?.length);
                showTableError('Error preparing submission data for display');
            }
        }

        // Sort Table
        function sortTable(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'desc';
            }
            applyFiltersAndSort();
        }

        // Update Table Statistics
        function updateTableStats() {
            try {
                console.log('Updating table stats...');
                console.log('filteredSubmissions length:', filteredSubmissions.length);
                console.log('allSubmissions length:', allSubmissions.length);

                const filteredCountEl = document.getElementById('filtered-count');
                const totalCountEl = document.getElementById('total-count');
                const summary = document.getElementById('table-summary');

                if (filteredCountEl) filteredCountEl.textContent = filteredSubmissions.length;
                if (totalCountEl) totalCountEl.textContent = allSubmissions.length;

                if (summary) {
                    if (searchTerm || statusFilter !== 'all' || bankFilter !== 'all' || minAmount > 0) {
                        summary.textContent = 'Filtered results';
                        summary.className = 'text-blue-600 font-medium';
                    } else {
                        summary.textContent = 'All submissions';
                        summary.className = 'text-slate-600';
                    }
                }

                console.log('Table stats updated successfully');
            } catch (statsError) {
                console.error('Error updating table stats:', statsError);
            }
        }

        // Show Table Error
        function showTableError(message) {
            document.getElementById('submissions-body').innerHTML = `
                <tr>
                    <td colspan="9" class="px-6 py-4 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        ${message}
                    </td>
                </tr>
            `;
        }

        // Display Submissions
        function displaySubmissions(submissions) {
            console.log('displaySubmissions called with:', {
                type: typeof submissions,
                isArray: Array.isArray(submissions),
                length: submissions?.length,
                sample: submissions?.[0]
            });

            const tbody = document.getElementById('submissions-body');

            if (!tbody) {
                console.error('DOM element not found for submissions display');
                return;
            }

            if (!submissions || !Array.isArray(submissions)) {
                console.error('Invalid submissions data:', submissions);
                showTableError('Invalid submissions data received');
                return;
            }

            if (submissions.length === 0) {
                console.log('No submissions to display');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center justify-center space-y-4">
                                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-inbox text-slate-400 text-2xl"></i>
                                </div>
                                <p class="text-slate-600 font-medium">No submissions found</p>
                                <p class="text-sm text-slate-500">Try adjusting your filters or check back later</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            console.log('Rendering', submissions.length, 'submissions');

            try {
                tbody.innerHTML = submissions.map((submission, index) => {
                    try {
                        console.log(`Rendering submission ${index}:`, submission);
                        console.log(`Submission keys:`, Object.keys(submission));
                        return `
                            <tr class="group hover:bg-gradient-to-r hover:from-slate-50 hover:to-blue-50/30 transition-all duration-300 border-b border-slate-100/50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-8 h-8 bg-gradient-to-br from-slate-100 to-slate-200 rounded-lg flex items-center justify-center group-hover:from-blue-100 group-hover:to-blue-200 transition-all duration-300">
                                            <i class="fas fa-receipt text-slate-500 group-hover:text-blue-600 text-xs"></i>
                                        </div>
                                        <span class="text-sm font-mono font-semibold text-slate-900 group-hover:text-blue-900 transition-colors duration-300">
                                            ${submission.transaction_reference || 'N/A'}
                                        </span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-8 h-8 bg-gradient-to-br from-green-100 to-green-200 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-user text-green-600 text-xs"></i>
                                        </div>
                                        <span class="text-sm font-medium text-slate-900">${submission.donor_name || 'N/A'}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-8 h-8 bg-gradient-to-br from-purple-100 to-purple-200 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-envelope text-purple-600 text-xs"></i>
                                        </div>
                                        <span class="text-sm text-slate-600 font-mono">${submission.donor_contact || 'N/A'}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-8 h-8 bg-gradient-to-br from-orange-100 to-orange-200 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-university text-orange-600 text-xs"></i>
                                        </div>
                                        <span class="text-sm font-medium text-slate-900">${submission.bank_used || 'N/A'}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-8 h-8 bg-gradient-to-br from-emerald-100 to-emerald-200 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-coins text-emerald-600 text-xs"></i>
                                        </div>
                                        <span class="text-sm font-bold text-slate-900">${submission.amount_donated || 'N/A'} ETB</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold transition-all duration-300 ${
                                        submission.is_verified
                                            ? 'bg-gradient-to-r from-green-100 to-green-200 text-green-800 border border-green-300 shadow-sm'
                                            : 'bg-gradient-to-r from-yellow-100 to-yellow-200 text-yellow-800 border border-yellow-300 shadow-sm'
                                    }">
                                        <i class="fas ${submission.is_verified ? 'fa-check-circle' : 'fa-clock'} mr-1"></i>
                                        ${submission.is_verified ? 'Verified' : 'Pending'}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-8 h-8 bg-gradient-to-br from-blue-100 to-blue-200 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-calendar text-blue-600 text-xs"></i>
                                        </div>
                                        <span class="text-sm text-slate-600 font-medium">${submission.submitted_at ? new Date(submission.submitted_at).toLocaleDateString() : 'N/A'}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center justify-center">
                                        ${submission.proof_image_path ? `
                                            <button onclick="viewImage('${submission.proof_image_path}')"
                                                    class="inline-flex items-center px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-md shadow-sm hover:shadow transition-all duration-200">
                                                <i class="fas fa-eye mr-2"></i>View
                                            </button>
                                        ` : `
                                            <span class="text-sm text-gray-400 italic">No image</span>
                                        `}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right">
                                    <div class="flex items-center justify-end">
                                        <button onclick="toggleVerification(${submission.id}, ${!submission.is_verified})"
                                                class="inline-flex items-center px-3 py-2 text-xs font-medium rounded-md shadow-sm hover:shadow transition-all duration-200 ${
                                                    submission.is_verified
                                                        ? 'bg-orange-600 hover:bg-orange-700 text-white'
                                                        : 'bg-emerald-600 hover:bg-emerald-700 text-white'
                                                }">
                                            <i class="fas ${submission.is_verified ? 'fa-times-circle' : 'fa-check-circle'} mr-1.5"></i>
                                            ${submission.is_verified ? 'Unverify' : 'Verify'}
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } catch (submissionError) {
                        console.error('Error rendering submission:', submissionError, submission);
                        return `
                            <tr class="bg-red-50">
                                <td colspan="9" class="px-6 py-4 text-center text-red-600">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    Error displaying submission data
                                </td>
                            </tr>
                        `;
                    }
                }).join('');
            } catch (renderError) {
                console.error('Error rendering submissions table:', renderError);
                showTableError('Error rendering submissions table');
            }
        }

        // Confirmation Modal Functions
        function showConfirmation(title, message, onConfirm, type = 'warning') {
            const modal = document.getElementById('confirmation-modal');
            const titleEl = document.getElementById('confirmation-title');
            const messageEl = document.getElementById('confirmation-message');
            const iconEl = document.getElementById('confirmation-icon');
            const confirmBtn = document.getElementById('confirmation-confirm');
            const cancelBtn = document.getElementById('confirmation-cancel');

            // Set content
            titleEl.textContent = title;
            messageEl.textContent = message;

            // Set icon and colors based on type
            if (type === 'verify') {
                iconEl.innerHTML = '<i class="fas fa-check-circle text-2xl text-emerald-600"></i>';
                iconEl.className = 'flex-shrink-0 w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center';
                confirmBtn.className = 'flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg text-sm font-semibold text-white shadow-sm hover:shadow transition-all duration-200';
            } else if (type === 'unverify') {
                iconEl.innerHTML = '<i class="fas fa-exclamation-triangle text-2xl text-orange-600"></i>';
                iconEl.className = 'flex-shrink-0 w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center';
                confirmBtn.className = 'flex-1 px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm font-semibold text-white shadow-sm hover:shadow transition-all duration-200';
            }

            // Show modal
            modal.classList.remove('hidden');

            // Handle confirm
            confirmBtn.onclick = function() {
                modal.classList.add('hidden');
                onConfirm();
            };

            // Handle cancel
            cancelBtn.onclick = function() {
                modal.classList.add('hidden');
            };

            // Close on clicking outside
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            };
        }

        // Toggle Verification with Confirmation
        async function toggleVerification(submissionId, verify) {
            // Get submission details for better context
            const submission = allSubmissions.find(s => s.id === submissionId);
            const donorName = submission ? submission.donor_name : 'this donation';
            const amount = submission ? submission.amount_donated : '';

            if (verify) {
                // Confirming verification
                showConfirmation(
                    'Verify Donation',
                    `Are you sure you want to verify this donation from ${donorName}${amount ? ' (' + amount + ' ETB)' : ''}? This will mark it as confirmed and authentic.`,
                    () => executeVerification(submissionId, verify),
                    'verify'
                );
            } else {
                // Confirming unverification
                showConfirmation(
                    'Unverify Donation',
                    `Are you sure you want to unverify this donation from ${donorName}${amount ? ' (' + amount + ' ETB)' : ''}? This will mark it as pending verification again.`,
                    () => executeVerification(submissionId, verify),
                    'unverify'
                );
            }
        }

        // Execute Verification (after confirmation)
        async function executeVerification(submissionId, verify) {
            try {
                const token = getStoredToken();
                if (!token) {
                    showToast('Authentication required. Please log in again.', 'error');
                    return;
                }

                const response = await fetch(`${API_BASE}/api/admin/submissions/${submissionId}/verify?is_verified=${verify}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    await loadSubmissions();
                    showToast(
                        verify ? 'Donation verified successfully!' : 'Donation unverified successfully!',
                        'success'
                    );
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showToast(`Error: ${errorData.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error updating verification:', error);
                showToast('Error updating verification status', 'error');
            }
        }

        // View Image with Authentication
        async function viewImage(imagePath) {
            const imageModal = document.getElementById('image-modal');
            const imageLoading = document.getElementById('image-loading');
            const imageContent = document.getElementById('image-content');
            const imageError = document.getElementById('image-error');
            const previewImage = document.getElementById('preview-image');

            // Show modal
            imageModal.classList.remove('hidden');
            imageLoading.classList.remove('hidden');
            imageContent.classList.add('hidden');
            imageError.classList.add('hidden');

            try {
                const token = getStoredToken();
                if (!token) {
                    throw new Error('Authentication required');
                }

                const imageUrl = `${API_BASE}/api/admin/images/${imagePath}`;
                const response = await fetch(imageUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load image');
                }

                // Convert response to blob and create object URL
                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);
                
                // Display image
                previewImage.src = objectUrl;
                imageLoading.classList.add('hidden');
                imageContent.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading image:', error);
                imageLoading.classList.add('hidden');
                imageError.classList.remove('hidden');
            }
        }

        // Close Image Modal
        document.addEventListener('DOMContentLoaded', function() {
            const imageModal = document.getElementById('image-modal');
            const closeImageModal = document.getElementById('close-image-modal');

            if (closeImageModal) {
                closeImageModal.addEventListener('click', function() {
                    imageModal.classList.add('hidden');
                    // Clean up object URL
                    const previewImage = document.getElementById('preview-image');
                    if (previewImage.src.startsWith('blob:')) {
                        URL.revokeObjectURL(previewImage.src);
                        previewImage.src = '';
                    }
                });
            }

            // Close on clicking outside
            if (imageModal) {
                imageModal.addEventListener('click', function(e) {
                    if (e.target === imageModal) {
                        closeImageModal.click();
                    }
                });
            }
        });

        // Update Pagination
        function updatePagination() {
            try {
                console.log('Updating pagination...');
                console.log('filteredSubmissions length:', filteredSubmissions.length);
                console.log('itemsPerPage:', itemsPerPage);
                console.log('currentPage:', currentPage);

                if (!filteredSubmissions || !Array.isArray(filteredSubmissions)) {
                    console.error('filteredSubmissions is not available for pagination');
                    return;
                }

                const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);
                const startRecord = currentPage * itemsPerPage + 1;
                const endRecord = Math.min((currentPage + 1) * itemsPerPage, filteredSubmissions.length);

                console.log('Pagination calc:', { totalPages, startRecord, endRecord });

                const startRecordEl = document.getElementById('start-record');
                const endRecordEl = document.getElementById('end-record');
                const totalRecordsEl = document.getElementById('total-records');
                const prevPageBtn = document.getElementById('prev-page');
                const nextPageBtn = document.getElementById('next-page');

                if (startRecordEl) startRecordEl.textContent = filteredSubmissions.length > 0 ? startRecord : 0;
                if (endRecordEl) endRecordEl.textContent = endRecord;
                if (totalRecordsEl) totalRecordsEl.textContent = filteredSubmissions.length;

                if (prevPageBtn) prevPageBtn.disabled = currentPage === 0;
                if (nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages - 1;

                console.log('Pagination updated successfully');
            } catch (paginationError) {
                console.error('Error updating pagination:', paginationError);
            }
        }

        // Pagination Handlers
        function initPaginationHandlers() {
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');

            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', function() {
                    if (currentPage > 0) {
                        currentPage--;
                        applyFiltersAndSort();
                    }
                });
            }

            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', function() {
                    if (filteredSubmissions && Array.isArray(filteredSubmissions)) {
                        const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);
                        if (currentPage < totalPages - 1) {
                            currentPage++;
                            applyFiltersAndSort();
                        }
                    }
                });
            }
        }

        // Refresh Handler
        function initRefreshHandler() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async function() {
                    // Add rotating animation to the button icon
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('rotating');
                    
                    currentPage = 0;
                    await loadDashboardStats();
                    await loadSubmissions();
                    // Re-apply current filters after refresh
                    applyFiltersAndSort();
                    
                    // Show toast notification
                    showToast('Data refreshed successfully', 'success', 2000);
                    
                    // Remove rotating animation after 1 second
                    setTimeout(() => {
                        icon.classList.remove('rotating');
                    }, 1000);
                });
            }
        }

        // Initialize Filter Event Listeners
        function initFilterListeners() {
            // Search input
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search');

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    searchTerm = this.value;
                    currentPage = 0;
                    applyFiltersAndSort();
                    updateActiveFilters();
                });
            }

            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    if (searchInput) searchInput.value = '';
                    searchTerm = '';
                    currentPage = 0;
                    applyFiltersAndSort();
                    updateActiveFilters();
                });
            }

            // Status filter
            const statusFilterEl = document.getElementById('status-filter');
            if (statusFilterEl) {
                statusFilterEl.addEventListener('change', function() {
                    statusFilter = this.value;
                    currentPage = 0;
                    applyFiltersAndSort();
                    updateActiveFilters();
                });
            }

            // Bank filter
            const bankFilterEl = document.getElementById('bank-filter');
            if (bankFilterEl) {
                bankFilterEl.addEventListener('change', function() {
                    bankFilter = this.value;
                    currentPage = 0;
                    applyFiltersAndSort();
                    updateActiveFilters();
                });
            }

            // Min amount filter
            const minAmountEl = document.getElementById('min-amount');
            if (minAmountEl) {
                minAmountEl.addEventListener('input', function() {
                    minAmount = parseFloat(this.value) || 0;
                    currentPage = 0;
                    applyFiltersAndSort();
                    updateActiveFilters();
                });
            }

            // Date filter
            const dateFilterEl = document.getElementById('date-filter');
            const customDateRange = document.getElementById('custom-date-range');
            if (dateFilterEl) {
                dateFilterEl.addEventListener('change', function() {
                    dateFilter = this.value;
                    
                    // Show/hide custom date range inputs
                    if (dateFilter === 'custom') {
                        customDateRange.classList.remove('hidden');
                    } else {
                        customDateRange.classList.add('hidden');
                        currentPage = 0;
                        applyFiltersAndSort();
                        updateActiveFilters();
                    }
                });
            }

            // Custom date range apply button
            const applyCustomDateBtn = document.getElementById('apply-custom-date');
            const dateFromInput = document.getElementById('date-from');
            const dateToInput = document.getElementById('date-to');
            
            if (applyCustomDateBtn && dateFromInput && dateToInput) {
                applyCustomDateBtn.addEventListener('click', function() {
                    customDateFrom = dateFromInput.value;
                    customDateTo = dateToInput.value;
                    
                    if (!customDateFrom || !customDateTo) {
                        showToast('Please select both start and end dates', 'warning');
                        return;
                    }
                    
                    if (new Date(customDateFrom) > new Date(customDateTo)) {
                        showToast('Start date must be before end date', 'error');
                        return;
                    }
                    
                    currentPage = 0;
                    applyFiltersAndSort();
                    updateActiveFilters();
                    showToast('Custom date range applied', 'success', 2000);
                });
            }

            // Rows per page
            const rowsPerPageEl = document.getElementById('rows-per-page');
            if (rowsPerPageEl) {
                rowsPerPageEl.addEventListener('change', function() {
                    itemsPerPage = parseInt(this.value);
                    currentPage = 0;
                    applyFiltersAndSort();
                });
            }
        }

        // Update Active Filters Display
        function updateActiveFilters() {
            const activeFilters = document.getElementById('active-filters');
            const filters = [];

            if (searchTerm) filters.push(`Search: "${searchTerm}"`);
            if (statusFilter !== 'all') filters.push(`Status: ${statusFilter}`);
            if (dateFilter !== 'all') {
                if (dateFilter === 'custom' && customDateFrom && customDateTo) {
                    filters.push(`Date: ${customDateFrom} to ${customDateTo}`);
                } else {
                    const dateLabel = document.getElementById('date-filter').selectedOptions[0].text;
                    filters.push(`Period: ${dateLabel}`);
                }
            }
            if (bankFilter !== 'all') filters.push(`Bank: ${bankFilter}`);
            if (minAmount > 0) filters.push(`Min Amount: ${minAmount}`);

            if (filters.length > 0) {
                activeFilters.innerHTML = `
                    <span class="text-sm font-medium text-slate-600">Active filters:</span>
                    ${filters.map(filter => `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ml-2">${filter}</span>`).join('')}
                    <button onclick="clearAllFilters()" class="ml-2 px-2 py-1 text-xs text-slate-500 hover:text-slate-700 transition-colors duration-300">
                        <i class="fas fa-times mr-1"></i>Clear all
                    </button>
                `;
                activeFilters.classList.remove('hidden');
            } else {
                activeFilters.classList.add('hidden');
            }
        }

        // Clear All Filters
        function clearAllFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('status-filter').value = 'all';
            document.getElementById('date-filter').value = 'all';
            document.getElementById('bank-filter').value = 'all';
            document.getElementById('min-amount').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            document.getElementById('custom-date-range').classList.add('hidden');

            searchTerm = '';
            statusFilter = 'all';
            dateFilter = 'all';
            bankFilter = 'all';
            minAmount = 0;
            customDateFrom = null;
            customDateTo = null;

            currentPage = 0;
            applyFiltersAndSort();
            updateActiveFilters();
        }

        // Populate Bank Filter Options
        async function populateBankFilter() {
            try {
                const token = getStoredToken();
                if (!token) {
                    console.log('No token available for bank filter');
                    return;
                }

                const response = await fetch(`${API_BASE}/api/admin/submissions?limit=1000&verified_only=false`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const submissions = await response.json();
                    const banks = [...new Set(submissions.map(s => s.bank_used))].sort();

                    const bankSelect = document.getElementById('bank-filter');
                    banks.forEach(bank => {
                        const option = document.createElement('option');
                        option.value = bank.toLowerCase();
                        option.textContent = bank;
                        bankSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading banks for filter:', error);
            }
        }

        // Initialize Export Handlers
        function initExportHandlers() {
            const csvBtn = document.getElementById('export-csv-btn');
            const excelBtn = document.getElementById('export-excel-btn');

            console.log('Initializing export handlers...');
            console.log('CSV button found:', !!csvBtn);
            console.log('Excel button found:', !!excelBtn);

            if (csvBtn) {
                csvBtn.disabled = false;
                csvBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('CSV export clicked');
                    exportData('csv');
                });
                console.log('CSV export handler attached');
            } else {
                console.error('CSV export button not found!');
            }

            if (excelBtn) {
                excelBtn.disabled = false;
                excelBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Excel export clicked');
                    exportData('excel');
                });
                console.log('Excel export handler attached');
            } else {
                console.error('Excel export button not found!');
            }
        }

        // Export Function
        async function exportData(format) {
            console.log('Export function called with format:', format);
            try {
                const params = new URLSearchParams({
                    format: format,
                    verified_only: false  // Export all submissions - filtering is handled client-side
                });

                console.log('Export params:', params.toString());

                const token = getStoredToken();
                if (!token) {
                    console.error('No token available for export');
                    showToast('Authentication required. Please log in again.', 'error');
                    return;
                }

                console.log('Token available, proceeding with export');

                // Show loading toast
                showToast(`Generating ${format.toUpperCase()} file...`, 'info', 2000);

                // Disable export buttons temporarily
                const csvBtn = document.getElementById('export-csv-btn');
                const excelBtn = document.getElementById('export-excel-btn');
                
                if (!csvBtn || !excelBtn) {
                    console.error('Export buttons not found');
                    return;
                }
                
                const originalCsvText = csvBtn.innerHTML;
                const originalExcelText = excelBtn.innerHTML;
                
                if (format === 'csv') {
                    csvBtn.disabled = true;
                    csvBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Exporting...';
                } else {
                    excelBtn.disabled = true;
                    excelBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Exporting...';
                }

                console.log('Making export request to:', `${API_BASE}/api/admin/export?${params}`);
                
                const response = await fetch(`${API_BASE}/api/admin/export?${params}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('Export response status:', response.status);
                console.log('Export response headers:', response.headers);

                if (response.ok) {
                    console.log('Export response OK, downloading file');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    
                    // Generate filename with date
                    const date = new Date().toISOString().split('T')[0];
                    const extension = format === 'excel' ? 'xlsx' : 'csv';
                    a.download = `donation_submissions_${date}.${extension}`;
                    
                    document.body.appendChild(a);
                    a.click();
                    
                    // Clean up
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }, 100);
                    
                    showToast(`${format.toUpperCase()} file downloaded successfully!`, 'success');
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    showToast(`Error: ${errorData.detail || 'Failed to export data'}`, 'error');
                }

                // Re-enable buttons
                if (format === 'csv') {
                    csvBtn.disabled = false;
                    csvBtn.innerHTML = originalCsvText;
                } else {
                    excelBtn.disabled = false;
                    excelBtn.innerHTML = originalExcelText;
                }

            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting data. Please try again.', 'error');
                
                // Re-enable buttons
                const csvBtn = document.getElementById('export-csv-btn');
                const excelBtn = document.getElementById('export-excel-btn');
                csvBtn.disabled = false;
                excelBtn.disabled = false;
            }
        }
    </script>
</body>
</html>

